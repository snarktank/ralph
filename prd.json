{
  "branchName": "ralph/docker-build-optimization",
  "description": "Optimize Docker build from 1+ hour to under 10 minutes using cargo-chef, sccache, BuildKit caching, and cross-compilation",
  "project": "Ralph",
  "userStories": [
    {
      "acceptanceCriteria": [
        "Add cargo-chef planner stage that generates recipe.json from Cargo.toml/Cargo.lock",
        "Add cargo-chef cook stage that builds dependencies from recipe",
        "Builder stage copies source and builds only application code",
        "Use same Rust version (1.85) across all stages",
        "Source code changes don't invalidate dependency cache layer",
        "Docker build succeeds locally with `docker build -t ralph .`",
        "Typecheck passes"
      ],
      "description": "As a CI system, I want to cache compiled Rust dependencies separately from source code so that dependency changes don't require full rebuilds.",
      "id": "US-001",
      "notes": "Foundation for all other optimizations. See https://github.com/LukeMathWalker/cargo-chef",
      "passes": true,
      "priority": 1,
      "title": "Add cargo-chef for dependency caching"
    },
    {
      "acceptanceCriteria": [
        "Install sccache in builder stage",
        "Set RUSTC_WRAPPER=sccache environment variable",
        "Set SCCACHE_DIR=/sccache for cache location",
        "Add BuildKit cache mount for sccache directory with --mount=type=cache",
        "sccache stats show cache hits on rebuilds",
        "Docker build succeeds locally",
        "Typecheck passes"
      ],
      "description": "As a CI system, I want fine-grained compiler caching so that unchanged compilation units are reused across builds.",
      "id": "US-002",
      "notes": "Provides fine-grained caching even when dependencies change",
      "passes": true,
      "priority": 2,
      "title": "Add sccache for compiler-level caching"
    },
    {
      "acceptanceCriteria": [
        "Add --mount=type=cache,target=/usr/local/cargo/registry for registry cache",
        "Add --mount=type=cache,target=/usr/local/cargo/git for git deps cache",
        "Use sharing=locked to prevent concurrent access issues",
        "Dockerfile has `# syntax=docker/dockerfile:1` directive at top",
        "Crate downloads cached between builds (verify with docker build output)",
        "Docker build succeeds locally",
        "Typecheck passes"
      ],
      "description": "As a CI system, I want to cache the cargo registry and git dependencies so that crate downloads are not repeated.",
      "id": "US-003",
      "notes": "Works with BuildKit which is default in modern Docker",
      "passes": true,
      "priority": 3,
      "title": "Add BuildKit cache mounts for cargo registry"
    },
    {
      "acceptanceCriteria": [
        "Install zig toolchain in builder stage",
        "Install cargo-zigbuild via cargo install",
        "Add x86_64-unknown-linux-musl and aarch64-unknown-linux-musl targets",
        "Change cargo build to cargo zigbuild --release --target x86_64-unknown-linux-musl --target aarch64-unknown-linux-musl",
        "Runtime stage uses ARG TARGETPLATFORM to copy correct binary",
        "Use alpine or musl-based runtime image for static linking",
        "Multi-arch build succeeds: docker buildx build --platform linux/amd64,linux/arm64",
        "Typecheck passes"
      ],
      "description": "As a CI system, I want to cross-compile for both architectures natively instead of using slow QEMU emulation.",
      "id": "US-004",
      "notes": "Eliminates QEMU emulation which causes 40x slowdown",
      "passes": true,
      "priority": 4,
      "title": "Implement cross-compilation with cargo-zigbuild"
    },
    {
      "acceptanceCriteria": [
        "Remove docker/setup-qemu-action (no longer needed)",
        "Keep docker/setup-buildx-action for BuildKit",
        "Configure cache-from and cache-to with type=gha",
        "Add DOCKER_BUILDKIT=1 environment variable",
        "Add build timing step that outputs duration",
        "Workflow file passes YAML lint",
        "Push to branch triggers successful build"
      ],
      "description": "As a maintainer, I want the CI workflow to leverage all caching optimizations for fastest possible builds.",
      "id": "US-005",
      "notes": "Workflow is at .github/workflows/docker.yml",
      "passes": true,
      "priority": 5,
      "title": "Update GitHub Actions workflow for optimized builds"
    },
    {
      "acceptanceCriteria": [
        "Local build completes successfully for both platforms",
        "CI build completes in under 15 minutes",
        "Incremental build (source change only) completes in under 5 minutes",
        "Built image runs correctly: docker run --rm ghcr.io/kcirtapfromspace/ralph --help",
        "MCP server mode works: docker run -i ghcr.io/kcirtapfromspace/ralph",
        "Image size is under 100MB",
        "Document benchmark results in PR description"
      ],
      "description": "As a maintainer, I want to verify the optimizations work and measure the improvement.",
      "id": "US-006",
      "notes": "Verify all optimizations work together",
      "passes": true,
      "priority": 6,
      "title": "Test and benchmark optimized builds"
    },
    {
      "acceptanceCriteria": [
        "Update docs/guides/docker-mcp-setup.md with optimized build section",
        "Document local build commands with BuildKit caching",
        "Explain cargo-chef, sccache, and zigbuild purpose",
        "Document cache invalidation scenarios",
        "Include benchmark comparison (before/after)",
        "All markdown links valid"
      ],
      "description": "As a developer, I want documentation explaining the build optimizations and how to build locally.",
      "id": "US-007",
      "notes": "",
      "passes": false,
      "priority": 7,
      "title": "Document build optimization"
    }
  ]
}