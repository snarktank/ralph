{
  "branchName": "ralph/parallel-execution",
  "description": "Add parallel story execution to Ralph - dependency graph, conflict detection, and reconciliation",
  "project": "Ralph",
  "userStories": [
    {
      "acceptanceCriteria": [
        "Add petgraph = \"0.6\" to Cargo.toml dependencies",
        "Run cargo fetch to download the crate",
        "Typecheck passes (cargo check)"
      ],
      "description": "As a developer, I need the petgraph crate added to Cargo.toml so I can build dependency graphs.",
      "id": "US-001",
      "notes": "Foundation dependency for DAG operations",
      "passes": true,
      "priority": 1,
      "targetFiles": [
        "Cargo.toml",
        "Cargo.lock"
      ],
      "title": "Add petgraph dependency"
    },
    {
      "acceptanceCriteria": [
        "Add `dependsOn: Vec<String>` field to PrdUserStory struct with serde default",
        "Field is optional - existing PRDs without it continue to work",
        "Add unit test verifying deserialization with and without dependsOn",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [],
      "description": "As a PRD author, I want to specify explicit story dependencies.",
      "id": "US-002",
      "notes": "",
      "passes": true,
      "priority": 2,
      "targetFiles": [
        "src/mcp/tools/load_prd.rs"
      ],
      "title": "Extend PrdUserStory with dependsOn field"
    },
    {
      "acceptanceCriteria": [
        "Add `targetFiles: Vec<String>` field to PrdUserStory struct with serde default",
        "Field is optional - existing PRDs without it continue to work",
        "Add unit test verifying deserialization with and without targetFiles",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-002"
      ],
      "description": "As a PRD author, I want to specify which files a story will modify for conflict detection.",
      "id": "US-003",
      "notes": "",
      "passes": true,
      "priority": 3,
      "targetFiles": [
        "src/mcp/tools/load_prd.rs"
      ],
      "title": "Extend PrdUserStory with targetFiles field"
    },
    {
      "acceptanceCriteria": [
        "Create src/parallel/mod.rs with submodule declarations",
        "Declare submodules: dependency, inference, scheduler, conflict, reconcile",
        "Add `pub mod parallel;` to src/lib.rs or src/main.rs",
        "Create empty placeholder files for each submodule",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-001"
      ],
      "description": "As a developer, I need the parallel module directory and mod.rs created.",
      "id": "US-004",
      "notes": "",
      "passes": true,
      "priority": 4,
      "targetFiles": [
        "src/parallel/mod.rs",
        "src/lib.rs"
      ],
      "title": "Create parallel module structure"
    },
    {
      "acceptanceCriteria": [
        "Create StoryNode struct with id, priority, passes, depends_on, target_files fields",
        "Implement From<&PrdUserStory> for StoryNode",
        "Add Clone, Debug derives",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-004",
        "US-003"
      ],
      "description": "As a developer, I need a struct to represent stories in the dependency graph.",
      "id": "US-005",
      "notes": "",
      "passes": true,
      "priority": 5,
      "targetFiles": [
        "src/parallel/dependency.rs"
      ],
      "title": "Implement StoryNode struct"
    },
    {
      "acceptanceCriteria": [
        "Create DependencyGraph struct using petgraph::DiGraph",
        "Add id_to_node HashMap for O(1) node lookup by story ID",
        "Implement from_stories() constructor that builds graph from Vec<PrdUserStory>",
        "Add edges based on dependsOn relationships",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-005"
      ],
      "description": "As a developer, I need a DAG data structure to hold story dependencies.",
      "id": "US-006",
      "notes": "",
      "passes": true,
      "priority": 6,
      "targetFiles": [
        "src/parallel/dependency.rs"
      ],
      "title": "Implement DependencyGraph struct"
    },
    {
      "acceptanceCriteria": [
        "Implement validate() method that returns Result<(), DependencyError>",
        "Use petgraph::algo::is_cyclic_directed to detect cycles",
        "DependencyError::CycleDetected variant includes involved story IDs",
        "Add unit test with cyclic dependencies that should fail",
        "Add unit test with valid DAG that should pass",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-006"
      ],
      "description": "As a developer, I need to detect circular dependencies which are invalid.",
      "id": "US-007",
      "notes": "",
      "passes": true,
      "priority": 7,
      "targetFiles": [
        "src/parallel/dependency.rs"
      ],
      "title": "Implement cycle detection in DependencyGraph"
    },
    {
      "acceptanceCriteria": [
        "Implement topological_order() returning Result<Vec<String>, DependencyError>",
        "Use petgraph::algo::toposort",
        "Return story IDs in execution order (dependencies before dependents)",
        "Add unit test verifying correct order for multi-level dependencies",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-007"
      ],
      "description": "As a developer, I need to get a valid execution order respecting dependencies.",
      "id": "US-008",
      "notes": "",
      "passes": true,
      "priority": 8,
      "targetFiles": [
        "src/parallel/dependency.rs"
      ],
      "title": "Implement topological sort in DependencyGraph"
    },
    {
      "acceptanceCriteria": [
        "Implement get_ready_stories(&self, completed: &HashSet<String>) -> Vec<&StoryNode>",
        "Returns stories where: not passed, not in completed set, all dependencies in completed set",
        "Add unit test with partially completed stories",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-008"
      ],
      "description": "As a scheduler, I need to know which stories can execute now.",
      "id": "US-009",
      "notes": "",
      "passes": true,
      "priority": 9,
      "targetFiles": [
        "src/parallel/dependency.rs"
      ],
      "title": "Implement get_ready_stories in DependencyGraph"
    },
    {
      "acceptanceCriteria": [
        "Add glob = \"0.3\" to Cargo.toml dependencies",
        "Run cargo fetch to download the crate",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [],
      "description": "As a developer, I need glob pattern matching for targetFiles.",
      "id": "US-010",
      "notes": "",
      "passes": true,
      "priority": 10,
      "targetFiles": [
        "Cargo.toml",
        "Cargo.lock"
      ],
      "title": "Add glob dependency for pattern matching"
    },
    {
      "acceptanceCriteria": [
        "Implement infer_from_files(stories: &[StoryNode]) -> Vec<(String, String)> in inference.rs",
        "When story A and B have overlapping targetFiles patterns, higher priority becomes dependency",
        "Use glob crate for pattern matching",
        "Add unit test with overlapping patterns like src/**/*.rs",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-010",
        "US-009"
      ],
      "description": "As a user, I want dependencies auto-inferred from targetFiles overlap.",
      "id": "US-011",
      "notes": "",
      "passes": true,
      "priority": 11,
      "targetFiles": [
        "src/parallel/inference.rs"
      ],
      "title": "Implement file-based dependency inference"
    },
    {
      "acceptanceCriteria": [
        "Add infer_dependencies(&mut self) method to DependencyGraph",
        "Call infer_from_files and add resulting edges to graph",
        "Explicit dependsOn takes precedence (don't duplicate edges)",
        "Add unit test showing inferred edge added correctly",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-011"
      ],
      "description": "As a developer, I need inferred dependencies added to the graph.",
      "id": "US-012",
      "notes": "",
      "passes": true,
      "priority": 12,
      "targetFiles": [
        "src/parallel/dependency.rs",
        "src/parallel/inference.rs"
      ],
      "title": "Integrate inferred dependencies into DependencyGraph"
    },
    {
      "acceptanceCriteria": [
        "Create ParallelRunnerConfig struct with max_concurrency (default 3), infer_dependencies (default true), fallback_to_sequential (default true)",
        "Implement Default trait",
        "Add Clone, Debug derives",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-004"
      ],
      "description": "As a developer, I need configuration options for parallel execution.",
      "id": "US-013",
      "notes": "",
      "passes": true,
      "priority": 13,
      "targetFiles": [
        "src/parallel/scheduler.rs"
      ],
      "title": "Implement ParallelRunnerConfig struct"
    },
    {
      "acceptanceCriteria": [
        "Create ParallelExecutionState with in_flight, completed, failed HashMaps/Sets",
        "Add locked_files: HashMap<PathBuf, String> for file locking",
        "Implement Default trait",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-013"
      ],
      "description": "As a scheduler, I need to track execution state across parallel stories.",
      "id": "US-014",
      "notes": "",
      "passes": true,
      "priority": 14,
      "targetFiles": [
        "src/parallel/scheduler.rs"
      ],
      "title": "Implement ParallelExecutionState struct"
    },
    {
      "acceptanceCriteria": [
        "Create ParallelRunner struct with config, base_config, semaphore, execution_state fields",
        "Implement new() constructor taking ParallelRunnerConfig and RunnerConfig",
        "Use Arc<Semaphore> from tokio::sync for concurrency limiting",
        "Use Arc<RwLock<ParallelExecutionState>> for shared state",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-014"
      ],
      "description": "As a developer, I need the main parallel runner structure.",
      "id": "US-015",
      "notes": "",
      "passes": true,
      "priority": 15,
      "targetFiles": [
        "src/parallel/scheduler.rs"
      ],
      "title": "Implement ParallelRunner struct skeleton"
    },
    {
      "acceptanceCriteria": [
        "Implement async run(&self) -> RunResult method",
        "Load PRD and build DependencyGraph with inference",
        "Main loop: get_ready_stories -> spawn tasks -> wait for any completion -> repeat",
        "Use semaphore to limit concurrent executions",
        "Return RunResult with all_passed, stories_passed, total_stories",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-015",
        "US-012"
      ],
      "description": "As a user, I want parallel story execution.",
      "id": "US-016",
      "notes": "",
      "passes": true,
      "priority": 16,
      "targetFiles": [
        "src/parallel/scheduler.rs"
      ],
      "title": "Implement ParallelRunner::run main loop"
    },
    {
      "acceptanceCriteria": [
        "Add parallel: bool field to RunnerConfig (default false)",
        "Add parallel_config: Option<ParallelRunnerConfig> field",
        "Update Default implementation",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-013"
      ],
      "description": "As a developer, I need to enable parallel mode via config.",
      "id": "US-017",
      "notes": "",
      "passes": true,
      "priority": 17,
      "targetFiles": [
        "src/runner.rs"
      ],
      "title": "Add parallel field to RunnerConfig"
    },
    {
      "acceptanceCriteria": [
        "Modify Runner::run() to check config.parallel",
        "If parallel=true, create ParallelRunner and call run()",
        "If parallel=false, use existing sequential run_sequential() logic",
        "Move current run() body to run_sequential() method",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-017",
        "US-016"
      ],
      "description": "As a user, I want to use parallel execution when configured.",
      "id": "US-018",
      "notes": "",
      "passes": true,
      "priority": 18,
      "targetFiles": [
        "src/runner.rs"
      ],
      "title": "Route Runner to ParallelRunner when enabled"
    },
    {
      "acceptanceCriteria": [
        "#[arg(long)] parallel: bool flag added to CLI struct",
        "Pass value to RunnerConfig.parallel",
        "Help text: 'Enable parallel story execution'",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-018"
      ],
      "description": "As a developer, I want to enable parallel execution from CLI.",
      "id": "US-019",
      "notes": "",
      "passes": true,
      "priority": 19,
      "targetFiles": [
        "src/main.rs"
      ],
      "title": "Add --parallel CLI flag"
    },
    {
      "acceptanceCriteria": [
        "#[arg(long, default_value = \"3\")] max_concurrency: usize flag",
        "Pass value to ParallelRunnerConfig.max_concurrency",
        "0 means unlimited",
        "Help text: 'Max concurrent stories (0 = unlimited)'",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-019"
      ],
      "description": "As a developer, I want to control parallel concurrency from CLI.",
      "id": "US-020",
      "notes": "",
      "passes": true,
      "priority": 20,
      "targetFiles": [
        "src/main.rs"
      ],
      "title": "Add --max-concurrency CLI flag"
    },
    {
      "acceptanceCriteria": [
        "Before executing story, acquire locks on its targetFiles patterns",
        "If any file already locked by another story, skip this story for now",
        "Release locks when story completes (success or failure)",
        "Add acquire_locks and release_locks methods to ParallelExecutionState",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-016"
      ],
      "description": "As a developer, I need file locks to prevent concurrent modification.",
      "id": "US-021",
      "notes": "",
      "passes": true,
      "priority": 21,
      "targetFiles": [
        "src/parallel/scheduler.rs"
      ],
      "title": "Implement file locking in ParallelRunner"
    },
    {
      "acceptanceCriteria": [
        "Add git_mutex: Arc<tokio::sync::Mutex<()>> to ParallelRunner",
        "Wrap git add/commit operations in mutex lock",
        "Prevents concurrent git operations that could corrupt repo",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-021"
      ],
      "description": "As a developer, I need to serialize git operations across parallel stories.",
      "id": "US-022",
      "notes": "",
      "passes": true,
      "priority": 22,
      "targetFiles": [
        "src/parallel/scheduler.rs"
      ],
      "title": "Add git operation mutex"
    },
    {
      "acceptanceCriteria": [
        "Create ConflictStrategy enum with variants: FileBased, EntityBased, None",
        "Add to ParallelRunnerConfig with default FileBased",
        "Implement Clone, Debug, Default derives",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-004"
      ],
      "description": "As a developer, I need different conflict detection strategies.",
      "id": "US-023",
      "notes": "EntityBased requires tree-sitter, implement in later story",
      "passes": true,
      "priority": 23,
      "targetFiles": [
        "src/parallel/conflict.rs"
      ],
      "title": "Implement ConflictStrategy enum"
    },
    {
      "acceptanceCriteria": [
        "Create ConflictDetector struct with strategy field",
        "Implement detect_file_conflicts(a: &ExecutionResult, b: &ExecutionResult) -> Vec<Conflict>",
        "Conflict struct has file, story_a, story_b fields",
        "Returns conflicts when files_changed sets overlap",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-023"
      ],
      "description": "As a developer, I need to detect when parallel stories modify same files.",
      "id": "US-024",
      "notes": "",
      "passes": true,
      "priority": 24,
      "targetFiles": [
        "src/parallel/conflict.rs"
      ],
      "title": "Implement file-based conflict detection"
    },
    {
      "acceptanceCriteria": [
        "When conflict detected pre-execution (overlapping targetFiles), don't run both in parallel",
        "Run higher-priority story first, then run conflicting story in next batch",
        "Log when fallback is triggered with story IDs",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-024"
      ],
      "description": "As a user, I want conflicting stories to run sequentially instead of failing.",
      "id": "US-025",
      "notes": "",
      "passes": true,
      "priority": 25,
      "targetFiles": [
        "src/parallel/scheduler.rs"
      ],
      "title": "Implement sequential fallback on conflict"
    },
    {
      "acceptanceCriteria": [
        "Create ReconciliationEngine struct with project_root field",
        "Implement new(project_root: PathBuf) constructor",
        "Create ReconciliationResult enum: Clean, IssuesFound(Vec<ReconciliationIssue>)",
        "Create ReconciliationIssue enum with GitConflict, TypeMismatch, ImportDuplicate variants",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-004"
      ],
      "description": "As a developer, I need reconciliation infrastructure.",
      "id": "US-026",
      "notes": "",
      "passes": true,
      "priority": 26,
      "targetFiles": [
        "src/parallel/reconcile.rs"
      ],
      "title": "Implement ReconciliationEngine skeleton"
    },
    {
      "acceptanceCriteria": [
        "Implement check_git_conflicts() method in ReconciliationEngine",
        "Run git status and detect conflict markers",
        "Return GitConflict issues with affected file paths",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-026"
      ],
      "description": "As a user, I want to know if parallel execution caused git merge conflicts.",
      "id": "US-027",
      "notes": "",
      "passes": true,
      "priority": 27,
      "targetFiles": [
        "src/parallel/reconcile.rs"
      ],
      "title": "Implement git conflict detection in reconciliation"
    },
    {
      "acceptanceCriteria": [
        "Implement check_type_errors() method",
        "Run cargo check for Rust projects",
        "Parse output for error messages",
        "Return TypeMismatch issues with file and error",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-027"
      ],
      "description": "As a user, I want to verify code still compiles after parallel execution.",
      "id": "US-028",
      "notes": "",
      "passes": true,
      "priority": 28,
      "targetFiles": [
        "src/parallel/reconcile.rs"
      ],
      "title": "Implement type check in reconciliation"
    },
    {
      "acceptanceCriteria": [
        "After each parallel batch completes, instantiate ReconciliationEngine",
        "Call reconcile() and log any issues found",
        "If issues found and fallback enabled, retry affected stories sequentially",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-028",
        "US-025"
      ],
      "description": "As a user, I want reconciliation to run after parallel batch completion.",
      "id": "US-029",
      "notes": "",
      "passes": true,
      "priority": 29,
      "targetFiles": [
        "src/parallel/scheduler.rs"
      ],
      "title": "Integrate reconciliation into ParallelRunner"
    },
    {
      "acceptanceCriteria": [
        "Add ParallelConfig struct with enabled, max_concurrency, conflict_strategy, inference_mode",
        "Add parallel: Option<ParallelConfig> field to PrdFile with serde default",
        "Existing PRDs without parallel section continue to work",
        "Add unit test for deserialization",
        "Typecheck passes (cargo check)"
      ],
      "dependsOn": [
        "US-003"
      ],
      "description": "As a PRD author, I want to configure parallelism in prd.json.",
      "id": "US-030",
      "notes": "",
      "passes": true,
      "priority": 30,
      "targetFiles": [
        "src/mcp/tools/load_prd.rs"
      ],
      "title": "Add parallel config section to PrdFile"
    },
    {
      "acceptanceCriteria": [
        "Test from_stories with simple 3-story DAG",
        "Test cycle detection with A->B->C->A cycle",
        "Test topological_order returns correct sequence",
        "Test get_ready_stories with varying completion states",
        "All tests pass (cargo test)"
      ],
      "dependsOn": [
        "US-012"
      ],
      "description": "As a developer, I need comprehensive tests for the dependency graph.",
      "id": "US-031",
      "notes": "",
      "passes": true,
      "priority": 31,
      "targetFiles": [
        "src/parallel/dependency.rs"
      ],
      "title": "Add unit tests for DependencyGraph"
    },
    {
      "acceptanceCriteria": [
        "Create test PRD with 3 independent stories",
        "Run with parallel=true, max_concurrency=3",
        "Verify all stories complete",
        "Test is in tests/integration/ directory",
        "All tests pass (cargo test)"
      ],
      "dependsOn": [
        "US-029"
      ],
      "description": "As a developer, I need an end-to-end test of parallel execution.",
      "id": "US-032",
      "notes": "",
      "passes": true,
      "priority": 32,
      "targetFiles": [
        "tests/integration/parallel_execution.rs"
      ],
      "title": "Add integration test for parallel execution"
    },
    {
      "acceptanceCriteria": [
        "Add Parallel Execution section to README",
        "Document --parallel and --max-concurrency flags",
        "Document dependsOn and targetFiles PRD fields",
        "Include example PRD with dependencies",
        "All markdown links valid"
      ],
      "dependsOn": [
        "US-032"
      ],
      "description": "As a user, I want documentation on how to use parallel execution.",
      "id": "US-033",
      "notes": "",
      "passes": false,
      "priority": 33,
      "targetFiles": [
        "README.md"
      ],
      "title": "Update README with parallel execution docs"
    }
  ]
}