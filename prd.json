{
  "project": "Ralph",
  "branchName": "ralph/advanced-scheduling",
  "description": "Advanced parallel scheduling with soft dependencies, critical path optimization, work-stealing, and speculative execution",
  "userStories": [
    {
      "id": "US-001",
      "title": "Define dependency strength types",
      "description": "As a developer, I need dependency strength types so that Ralph can classify dependencies by their blocking behavior.",
      "acceptanceCriteria": [
        "Create src/parallel/dependency_types.rs module",
        "Define DependencyStrength enum: Hard, Soft { risk_level: RiskLevel }, Preferred, Optional",
        "Define RiskLevel enum: Low, Medium, High",
        "Implement Default for DependencyStrength (returns Hard)",
        "Implement Display for DependencyStrength and RiskLevel",
        "Add Serialize/Deserialize derives for all types",
        "Unit tests for all enum variants",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Foundation for soft dependency support"
    },
    {
      "id": "US-002",
      "title": "Add strength field to DependencyEdge",
      "description": "As a developer, I need the dependency graph to store edge strength so that scheduling can use this information.",
      "acceptanceCriteria": [
        "Add strength: DependencyStrength field to DependencyEdge in src/parallel/dependency.rs",
        "Update DependencyEdge::new() to accept optional strength parameter",
        "Default to Hard when strength not specified",
        "Update add_dependency() to pass strength through",
        "Update from_stories() to use Hard for all existing dependencies",
        "Unit tests for edge strength storage",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Backward compatible - existing code defaults to Hard"
    },
    {
      "id": "US-003",
      "title": "Extend PRD schema for dependency strength",
      "description": "As a PRD author, I want to specify dependency strength so that I can express nuanced relationships.",
      "acceptanceCriteria": [
        "Update PrdUserStory in src/prd.rs to support dependsOn as Vec<DependencySpec>",
        "Define DependencySpec enum: Simple(String) for 'US-001', Complex { story, strength, risk } for objects",
        "Implement custom Deserialize to support both string and object formats",
        "Validate strength values during parsing",
        "Update dependency graph builder to extract strength from DependencySpec",
        "Unit tests for parsing both simple and complex dependency formats",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "String format backward compatible, object format adds strength"
    },
    {
      "id": "US-004",
      "title": "Implement soft dependency scheduler logic",
      "description": "As a user, I want Ralph to proceed with soft dependencies so that execution is faster when risk is acceptable.",
      "acceptanceCriteria": [
        "Modify get_ready_stories() in src/parallel/dependency.rs",
        "Hard dependencies block until satisfied",
        "Soft dependencies allow story to be returned as ready",
        "Add get_unsatisfied_soft_deps() to return soft deps still in progress",
        "Preferred dependencies influence sort order but don't block",
        "Optional dependencies are ignored for scheduling",
        "Unit tests for each dependency strength behavior",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Core soft dependency scheduling logic"
    },
    {
      "id": "US-005",
      "title": "Track stories with pending soft dependencies",
      "description": "As a developer, I need to track which stories ran with unsatisfied soft dependencies so that reconciliation knows what to check.",
      "acceptanceCriteria": [
        "Add soft_dep_executions: HashMap<String, Vec<String>> to ParallelExecutionState",
        "Key is story_id, value is list of unsatisfied soft dependency story_ids",
        "Populate when story starts with pending soft deps",
        "Clear entry when soft dep completes without conflict",
        "Provide get_stories_needing_reconciliation() method",
        "Unit tests for tracking logic",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Enables targeted reconciliation after soft dep completion"
    },
    {
      "id": "US-006",
      "title": "Implement soft dependency reconciliation",
      "description": "As a user, I want Ralph to reconcile changes when soft dependencies complete so that conflicts are detected.",
      "acceptanceCriteria": [
        "Add reconcile_soft_dependency() method to ParallelRunner",
        "When soft dep story completes, check for file conflicts with dependent stories",
        "If conflict detected, mark dependent story for re-execution",
        "If no conflict, continue normally",
        "Log reconciliation decisions with story IDs",
        "Add --no-soft-deps CLI flag to disable soft dependency parallelism",
        "Unit tests for reconciliation scenarios",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Ensures correctness when soft deps have conflicts"
    },
    {
      "id": "US-007",
      "title": "Create critical path analyzer module",
      "description": "As a developer, I need critical path analysis to identify the longest execution chain.",
      "acceptanceCriteria": [
        "Create src/parallel/critical_path.rs module",
        "Define CriticalPathAnalyzer struct with reference to DependencyGraph",
        "Implement calculate_earliest_start() using forward pass",
        "Implement calculate_latest_start() using backward pass",
        "Implement calculate_slack() as latest - earliest",
        "Add pub mod critical_path to src/parallel/mod.rs",
        "Unit tests for each calculation method",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Foundation for critical path optimization"
    },
    {
      "id": "US-008",
      "title": "Implement critical path identification",
      "description": "As a user, I want to see which stories are on the critical path so that I understand execution bottlenecks.",
      "acceptanceCriteria": [
        "Implement get_critical_path() returning Vec<String> of story IDs with zero slack",
        "Handle graphs with multiple critical paths",
        "Implement is_critical() to check if specific story is on critical path",
        "Use default weight of 1.0 for all stories initially",
        "Add get_path_length() to calculate total critical path duration",
        "Unit tests for critical path identification",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Zero slack stories form the critical path"
    },
    {
      "id": "US-009",
      "title": "Integrate critical path into scheduler priority",
      "description": "As a user, I want critical path stories prioritized so that total execution time is minimized.",
      "acceptanceCriteria": [
        "Calculate critical path in ParallelRunner::run() before execution loop",
        "Modify story selection in execute_next() to prioritize critical path",
        "Primary sort: is_critical (true first)",
        "Secondary sort: explicit priority field",
        "Tertiary sort: story order in PRD",
        "Log critical path stories at execution start",
        "Unit tests for priority ordering",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Critical path stories should never wait for non-critical"
    },
    {
      "id": "US-010",
      "title": "Add --show-critical-path CLI flag",
      "description": "As a user, I want to see critical path analysis without running execution.",
      "acceptanceCriteria": [
        "Add --show-critical-path flag to parallel run command",
        "Display critical path story IDs in order",
        "Show slack for each story",
        "Show estimated total duration",
        "Exit without executing when flag is set",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": "Useful for understanding PRD structure"
    },
    {
      "id": "US-011",
      "title": "Create work-stealing scheduler types",
      "description": "As a developer, I need work-stealing data structures for efficient task distribution.",
      "acceptanceCriteria": [
        "Create src/parallel/work_stealing.rs module",
        "Add crossbeam-deque dependency to Cargo.toml",
        "Define WorkerQueue using crossbeam_deque::Worker<StoryTask>",
        "Define StealerHandle using crossbeam_deque::Stealer<StoryTask>",
        "Define StoryTask struct with story_id and priority",
        "Define WorkStealingScheduler with worker_count and queues",
        "Unit tests for queue creation",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": "Uses crossbeam-deque for lock-free work-stealing"
    },
    {
      "id": "US-012",
      "title": "Implement work-stealing task distribution",
      "description": "As a developer, I need task distribution logic so that workers can steal from each other.",
      "acceptanceCriteria": [
        "Implement distribute_initial() to spread ready stories across workers",
        "Implement push_task() to add new task to least-loaded worker",
        "Implement pop_local() for worker to take from own queue (LIFO)",
        "Implement steal_from() to take from another worker's queue (FIFO)",
        "Implement try_steal_any() to attempt stealing from random worker",
        "Add backoff on failed steal attempts",
        "Unit tests for distribution and stealing",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": "LIFO local, FIFO stealing for cache efficiency"
    },
    {
      "id": "US-013",
      "title": "Implement work-stealing worker loop",
      "description": "As a developer, I need worker tasks that execute stories from their queues.",
      "acceptanceCriteria": [
        "Implement spawn_workers() to create tokio tasks for each worker",
        "Worker loop: pop_local -> try_steal_any -> sleep with backoff",
        "Pass executor to each worker for story execution",
        "Handle story completion by notifying dependency tracker",
        "Implement graceful shutdown via cancellation token",
        "Unit tests for worker lifecycle",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": "Workers run until all stories complete or cancelled"
    },
    {
      "id": "US-014",
      "title": "Integrate work-stealing into parallel runner",
      "description": "As a user, I want work-stealing scheduling for better performance.",
      "acceptanceCriteria": [
        "Add --work-stealing flag to parallel run command",
        "Add workStealing: bool to prd.json parallel config",
        "When enabled, use WorkStealingScheduler instead of semaphore",
        "Default to false for backward compatibility",
        "Fall back to semaphore if work-stealing initialization fails",
        "Integration test for work-stealing execution",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": "Opt-in feature, semaphore remains default"
    },
    {
      "id": "US-015",
      "title": "Implement work-stealing metrics",
      "description": "As a user, I want to see work-stealing statistics to understand scheduling efficiency.",
      "acceptanceCriteria": [
        "Track tasks_executed per worker",
        "Track steal_attempts and steal_successes",
        "Calculate steal_ratio (successes / attempts)",
        "Calculate load_balance (std dev of tasks per worker)",
        "Display metrics in execution summary when work-stealing enabled",
        "Log detailed per-worker stats when --verbose",
        "Unit tests for metrics calculation",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": "Helps tune worker count"
    },
    {
      "id": "US-016",
      "title": "Create speculative execution types",
      "description": "As a developer, I need speculative execution types for probabilistic parallelism.",
      "acceptanceCriteria": [
        "Create src/parallel/speculative.rs module",
        "Define IndependenceProbability as f64 wrapper (0.0 to 1.0)",
        "Define SpeculativeTask with story_id, blocking_story_id, probability",
        "Define SpeculationOutcome enum: Confirmed, Conflicted, Cancelled",
        "Define SpeculativeConfig with threshold (default 0.8) and max_concurrent (default 1)",
        "Unit tests for speculative types",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": "Foundation for speculative execution"
    },
    {
      "id": "US-017",
      "title": "Implement independence probability calculator",
      "description": "As Ralph, I need to calculate independence probability between story pairs.",
      "acceptanceCriteria": [
        "Implement calculate_independence() taking two story IDs",
        "Factor 1: File pattern overlap (inverse relationship)",
        "Factor 2: Historical conflict rate between similar stories",
        "Combine factors with configurable weights (default 0.7 file, 0.3 history)",
        "Cache probability calculations in HashMap",
        "Return IndependenceProbability struct",
        "Unit tests for probability calculation",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": "Higher probability = safer to speculate"
    },
    {
      "id": "US-018",
      "title": "Implement speculative execution engine",
      "description": "As a user, I want Ralph to speculatively execute likely-independent stories.",
      "acceptanceCriteria": [
        "Implement find_speculative_candidates() to identify high-probability blocked stories",
        "Implement start_speculative() to begin speculative execution",
        "Create git stash before speculative execution for rollback",
        "Track speculative executions in SpeculativeExecutionState",
        "Implement validate_speculation() called when blocking story completes",
        "Confirm or rollback based on conflict detection",
        "Unit tests for speculative execution flow",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": "Core speculative execution logic"
    },
    {
      "id": "US-019",
      "title": "Implement speculative rollback",
      "description": "As a developer, I need rollback capability for conflicted speculative work.",
      "acceptanceCriteria": [
        "Implement rollback_speculative() method",
        "Restore from git stash created before speculation",
        "Clean working directory to pre-speculative state",
        "Re-queue story for normal execution after dependency",
        "Log rollback with story IDs and conflict reason",
        "Handle case where stash apply fails",
        "Unit tests for rollback scenarios",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": false,
      "notes": "Git stash provides clean rollback mechanism"
    },
    {
      "id": "US-020",
      "title": "Add speculative execution CLI flags",
      "description": "As a user, I want CLI control over speculative execution.",
      "acceptanceCriteria": [
        "Add --speculative flag to enable speculative execution",
        "Add --speculation-threshold <0.0-1.0> to set confidence threshold",
        "Add --max-speculative <N> to limit concurrent speculative tasks",
        "Add speculativeExecution section to prd.json parallel config",
        "Document flags in help text",
        "Typecheck passes"
      ],
      "priority": 20,
      "passes": false,
      "notes": "Speculative execution is opt-in"
    },
    {
      "id": "US-021",
      "title": "Implement speculative execution metrics",
      "description": "As a user, I want to see speculation statistics to understand the risk/reward.",
      "acceptanceCriteria": [
        "Track speculations_attempted, confirmed, conflicted, cancelled",
        "Calculate speculation_success_rate",
        "Estimate time_saved from successful speculations",
        "Estimate time_wasted from failed speculations",
        "Display in execution summary when speculation enabled",
        "Recommend threshold adjustment if success rate too low/high",
        "Unit tests for metrics",
        "Typecheck passes"
      ],
      "priority": 21,
      "passes": false,
      "notes": "Helps tune speculation threshold"
    },
    {
      "id": "US-022",
      "title": "Integration tests for advanced scheduling",
      "description": "As a developer, I need integration tests to verify all advanced scheduling features work together.",
      "acceptanceCriteria": [
        "Create tests/advanced_scheduling_tests.rs",
        "Test soft dependency allows parallel execution",
        "Test soft dependency reconciliation on conflict",
        "Test critical path stories execute first",
        "Test work-stealing distributes tasks",
        "Test speculative execution with high probability",
        "Test speculative rollback on conflict",
        "All tests pass"
      ],
      "priority": 22,
      "passes": false,
      "notes": "End-to-end validation of all features"
    }
  ]
}
