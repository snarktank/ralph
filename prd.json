{
  "branchName": "ralph/codebase-audit",
  "description": "Add comprehensive codebase audit, inventory, and evaluation feature to Ralph - enabling pre-development context, architecture gap detection, interactive Q&A refinement, and automatic PRD generation with prd.json conversion for immediate execution",
  "project": "Ralph",
  "userStories": [
    {
      "acceptanceCriteria": [
        "Create src/audit/mod.rs with module organization and re-exports",
        "Define core types: AuditReport, AuditFinding, FeatureOpportunity, Severity",
        "Define AuditError enum with thiserror",
        "Add mod audit; to src/main.rs",
        "Typecheck passes"
      ],
      "description": "As a developer, I need the audit module scaffolding so other audit features can be built on top of it.",
      "id": "US-001",
      "notes": "Foundation module - all other audit features depend on this",
      "passes": true,
      "priority": 1,
      "title": "Create audit module structure"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/inventory.rs with InventoryScanner struct",
        "Scan directory tree respecting .gitignore patterns",
        "Count files by extension",
        "Identify key files (README, Cargo.toml, package.json, etc.)",
        "Calculate total lines of code",
        "Return FileInventory struct with results",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a user, I want the audit to scan the directory structure so I can see what files and folders exist in the codebase.",
      "id": "US-002",
      "notes": "Use ignore crate for .gitignore support",
      "passes": true,
      "priority": 2,
      "title": "Implement file inventory scanner"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/languages/mod.rs with LanguageDetector",
        "Detect Rust (Cargo.toml, .rs files)",
        "Detect TypeScript/JavaScript (package.json, .ts/.js files)",
        "Detect Python (pyproject.toml, requirements.txt, .py files)",
        "Detect Go (go.mod, .go files)",
        "Return primary and secondary languages with percentages",
        "Unit tests for each language detection",
        "Typecheck passes"
      ],
      "description": "As a user, I want the audit to detect which programming languages are used so I understand the tech stack.",
      "id": "US-003",
      "notes": "Languages detected by manifest files and file extensions",
      "passes": true,
      "priority": 3,
      "title": "Implement language detection"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/dependencies.rs with DependencyParser",
        "Parse Cargo.toml for Rust dependencies",
        "Parse package.json for npm dependencies",
        "Parse pyproject.toml/requirements.txt for Python dependencies",
        "Parse go.mod for Go dependencies",
        "Return DependencyAnalysis with direct and dev dependencies",
        "Unit tests for each ecosystem parser",
        "Typecheck passes"
      ],
      "description": "As a user, I want the audit to analyze dependencies so I can see what libraries the project uses.",
      "id": "US-004",
      "notes": "Use toml and serde_json crates for parsing",
      "passes": true,
      "priority": 4,
      "title": "Implement dependency parser"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/patterns.rs with PatternAnalyzer",
        "Detect naming conventions (snake_case, camelCase, PascalCase)",
        "Detect module organization patterns",
        "Detect error handling patterns",
        "Detect async patterns if applicable",
        "Return PatternAnalysis struct",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a user, I want the audit to detect code patterns and conventions so agents can follow existing practices.",
      "id": "US-005",
      "notes": "Use regex for pattern matching in source files",
      "passes": true,
      "priority": 5,
      "title": "Implement code pattern detection"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/architecture.rs with ArchitectureAnalyzer",
        "Detect architecture patterns (layered, modular, hexagonal, clean, etc.)",
        "Identify module/layer boundaries",
        "Detect coupling between modules",
        "Return ArchitectureAnalysis struct",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a user, I want the audit to identify the architecture pattern so I understand how the codebase is organized.",
      "id": "US-006",
      "notes": "Analyze directory structure and import patterns",
      "passes": true,
      "priority": 6,
      "title": "Implement architecture analysis"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/api.rs with ApiInventory",
        "Detect HTTP endpoints (axum, actix, express patterns)",
        "Detect CLI commands (clap patterns)",
        "Detect MCP tools if present",
        "Return ApiAnalysis with endpoints, commands, tools",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a user, I want the audit to discover API endpoints and interfaces so I know what the codebase exposes.",
      "id": "US-007",
      "notes": "Use regex to find route definitions and clap derives",
      "passes": true,
      "priority": 7,
      "title": "Implement API inventory"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/testing.rs with TestAnalyzer",
        "Count test files and test functions",
        "Identify untested modules (modules with no corresponding tests)",
        "Detect test patterns (unit, integration, e2e)",
        "Return TestAnalysis struct",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a user, I want the audit to analyze test coverage so I know which areas lack tests.",
      "id": "US-008",
      "notes": "Look for #[test] and #[cfg(test)] in Rust, test/spec files in JS",
      "passes": true,
      "priority": 8,
      "title": "Implement test coverage analysis"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/documentation.rs with DocAnalyzer",
        "Check for README presence and completeness",
        "Detect missing doc comments on public items (Rust)",
        "Identify undocumented API endpoints",
        "Return DocumentationAnalysis with gaps",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a user, I want the audit to find missing documentation so I know what needs to be documented.",
      "id": "US-009",
      "notes": "Look for /// comments before pub items in Rust",
      "passes": true,
      "priority": 9,
      "title": "Implement documentation gap detection"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/detectors/mod.rs and architecture_gaps.rs",
        "Detect missing abstraction layers",
        "Detect inconsistent module boundaries",
        "Detect layer violations (e.g., UI calling DB directly)",
        "Return list of AuditFinding with recommendations",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a user, I want the audit to identify architecture gaps so I know what improvements are needed.",
      "id": "US-010",
      "notes": "Analyze import patterns to detect violations",
      "passes": true,
      "priority": 10,
      "title": "Implement architecture gap detector"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/detectors/opportunities.rs",
        "Define opportunity patterns (e.g., has quality gates but no audit command)",
        "Match patterns against audit results",
        "Return list of FeatureOpportunity with suggested stories",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a user, I want the audit to suggest complementary features so I know what could be added.",
      "id": "US-011",
      "notes": "Pattern matching based on what exists vs what could exist",
      "passes": true,
      "priority": 11,
      "title": "Implement opportunity detector"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/detectors/tech_debt.rs",
        "Detect TODO/FIXME/HACK comments",
        "Detect outdated dependencies",
        "Detect dead code indicators",
        "Return list of AuditFinding for tech debt items",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a user, I want the audit to find technical debt so I can prioritize cleanup.",
      "id": "US-012",
      "notes": "Use regex to find TODO comments, compare dep versions",
      "passes": true,
      "priority": 12,
      "title": "Implement technical debt detector"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/output/mod.rs and structured.rs",
        "Serialize AuditReport to JSON",
        "Include all sections: metadata, inventory, dependencies, findings, opportunities",
        "Write to audit.json file",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a user, I want audit results in JSON format so tools can consume them programmatically.",
      "id": "US-013",
      "notes": "Use serde_json for serialization",
      "passes": true,
      "priority": 13,
      "title": "Implement JSON report output"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/output/markdown.rs",
        "Generate executive summary with key metrics",
        "Format findings with severity badges",
        "Format opportunities with complexity indicators",
        "Include table of contents",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a user, I want audit results in markdown format so I can read them easily.",
      "id": "US-014",
      "notes": "Generate GitHub-flavored markdown",
      "passes": true,
      "priority": 14,
      "title": "Implement markdown report output"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/output/agent_context.rs",
        "Generate Codebase Patterns section for progress.txt",
        "Include naming conventions, architecture pattern, key conventions",
        "Append to existing progress.txt (don't overwrite)",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a developer, I want audit patterns written to progress.txt so agents can follow existing conventions.",
      "id": "US-015",
      "notes": "Format matches existing progress.txt pattern",
      "passes": true,
      "priority": 15,
      "title": "Implement agent context output"
    },
    {
      "acceptanceCriteria": [
        "Add Audit variant to Commands enum in src/main.rs",
        "Support -d, --dir for target directory",
        "Support -f, --format for output format (json, markdown, context, all)",
        "Support -o, --output for output file",
        "Support --profile for quality profile",
        "Support --smart for smart Q&A mode",
        "Support --no-interactive to skip Q&A",
        "Support --generate-prd to auto-generate PRD",
        "Print help text with -h, --help",
        "Typecheck passes"
      ],
      "description": "As a user, I want to run ralph audit from the command line so I can audit any codebase.",
      "id": "US-016",
      "notes": "Follow existing Commands pattern in main.rs",
      "passes": true,
      "priority": 16,
      "title": "Add audit CLI subcommand"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/interactive.rs with Q&A logic",
        "Ask 3-5 questions with A/B/C/D options",
        "Questions include: project purpose, priorities, target users",
        "Parse user responses (e.g., 1A, 2C, 3B)",
        "Refine findings based on answers",
        "Skip questions in --no-interactive mode",
        "In --smart mode, only ask when confidence < threshold",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a user, I want the audit to ask me clarifying questions so it better understands my goals.",
      "id": "US-017",
      "notes": "Use console crate for terminal input",
      "passes": true,
      "priority": 17,
      "title": "Implement interactive Q&A flow"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/prd_generator.rs",
        "Convert findings to user stories",
        "Convert opportunities to user stories",
        "Generate PRD markdown following existing /prd skill format",
        "Save to tasks/prd-<project>-improvements.md",
        "Prompt user before generating (unless --generate-prd flag)",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a user, I want to generate a PRD from audit findings so I can start improving the codebase.",
      "id": "US-018",
      "notes": "Follow PRD format from skills/prd/SKILL.md",
      "passes": true,
      "priority": 18,
      "title": "Implement audit-to-PRD generation"
    },
    {
      "acceptanceCriteria": [
        "Create src/audit/prd_converter.rs",
        "Parse generated PRD markdown",
        "Extract user stories and acceptance criteria",
        "Generate valid prd.json with project, branchName, userStories",
        "Set all stories to passes: false",
        "Save to prd.json in working directory",
        "Prompt user before converting",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a user, I want the audit to convert the generated PRD to prd.json so I can run ralph immediately.",
      "id": "US-019",
      "notes": "Follow prd.json format from skills/ralph/SKILL.md",
      "passes": true,
      "priority": 19,
      "title": "Implement PRD-to-prd.json conversion"
    },
    {
      "acceptanceCriteria": [
        "Create skills/audit/SKILL.md with full skill instructions",
        "Define interactive Q&A flow matching CLI behavior",
        "Include instructions for presenting findings",
        "Include instructions for generating PRD",
        "Include instructions for converting to prd.json",
        "Skill follows existing /prd and /ralph skill patterns"
      ],
      "description": "As a user, I want to type /audit in Claude Code so I can run an interactive audit.",
      "id": "US-020",
      "notes": "Reference skills/prd/SKILL.md and skills/ralph/SKILL.md as templates",
      "passes": true,
      "priority": 20,
      "title": "Create /audit skill for Claude Code"
    },
    {
      "acceptanceCriteria": [
        "Create src/mcp/tools/audit.rs with start_audit tool",
        "Accept path parameter (optional, defaults to PRD directory)",
        "Accept sections parameter to limit analysis scope",
        "Accept format parameter for output format",
        "Return audit ID for status checking",
        "Register tool in src/mcp/server.rs",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As an AI agent, I want to start an audit via MCP so I can analyze codebases programmatically.",
      "id": "US-021",
      "notes": "Follow pattern from existing MCP tools in src/mcp/tools/",
      "passes": true,
      "priority": 21,
      "title": "Implement start_audit MCP tool"
    },
    {
      "acceptanceCriteria": [
        "Add get_audit_status tool to src/mcp/tools/audit.rs",
        "Accept audit ID parameter",
        "Return status: pending, running, completed, failed",
        "Return progress percentage if running",
        "Register tool in src/mcp/server.rs",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As an AI agent, I want to check audit progress so I know when it's complete.",
      "id": "US-022",
      "notes": "Status tracking similar to story execution state",
      "passes": true,
      "priority": 22,
      "title": "Implement get_audit_status MCP tool"
    },
    {
      "acceptanceCriteria": [
        "Add get_audit_results tool to src/mcp/tools/audit.rs",
        "Accept audit ID parameter",
        "Return full AuditReport as JSON",
        "Return error if audit not complete",
        "Register tool in src/mcp/server.rs",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As an AI agent, I want to retrieve audit results so I can present findings to the user.",
      "id": "US-023",
      "notes": "Serialize AuditReport to JSON for MCP response",
      "passes": true,
      "priority": 23,
      "title": "Implement get_audit_results MCP tool"
    },
    {
      "acceptanceCriteria": [
        "Add generate_prd_from_audit tool to src/mcp/tools/audit.rs",
        "Accept audit ID parameter",
        "Accept optional user answers from Q&A",
        "Generate PRD markdown and prd.json",
        "Return paths to generated files",
        "Register tool in src/mcp/server.rs",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As an AI agent, I want to generate a PRD from audit results so users can start improving their codebase.",
      "id": "US-024",
      "notes": "Reuse prd_generator and prd_converter modules",
      "passes": true,
      "priority": 24,
      "title": "Implement generate_prd_from_audit MCP tool"
    },
    {
      "acceptanceCriteria": [
        "Add [profiles.*.audit] section to quality/ralph-quality.toml",
        "Add enabled boolean",
        "Add max_critical_findings, max_high_findings thresholds",
        "Add section toggles (structure, patterns, api, deps, tests, docs, arch)",
        "Load audit config in quality profile loader",
        "Unit tests pass",
        "Typecheck passes"
      ],
      "description": "As a user, I want to configure audit behavior via quality profiles so I can customize thresholds.",
      "id": "US-025",
      "notes": "Follow existing profile pattern in src/quality/profiles.rs",
      "passes": true,
      "priority": 25,
      "title": "Add audit settings to quality profiles"
    },
    {
      "acceptanceCriteria": [
        "Create integration test that runs full audit on ralph codebase",
        "Verify all analysis sections produce results",
        "Verify JSON output is valid and parseable",
        "Verify markdown output is well-formed",
        "Verify findings are reasonable for Ralph codebase",
        "Test passes"
      ],
      "description": "As a developer, I want to run the audit on Ralph itself so I can verify it works end-to-end.",
      "id": "US-026",
      "notes": "Use tests/ directory for integration tests",
      "passes": true,
      "priority": 26,
      "title": "Integration test on Ralph's own codebase"
    }
  ]
}
